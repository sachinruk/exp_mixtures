\documentclass{article}
\usepackage[]{algorithm2e}
\usepackage{algpseudocode}
\usepackage{amsmath}
\usepackage{cleveref}
\usepackage{mathtools}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}

\input{eqn_abbr}

\title{Dirichlet Process}
\date{}
\begin{document}
\maketitle

\section{MCMC method}
Model:
\begin{align}
\lambda_i\propto\frac{1}{\lambda_i}\qquad \lambda_i\in[a,b]\\
p(z_n=k|z_{/n},\alpha)=\frac{n_k}{N-1+\alpha}\\
p(x_n|\mathbf{\lambda},z_n)=\lambda_{z_n}\exp(-\lambda_{z_n}x_n)
\end{align}

\section{Variational Bayes Method}
Model:
\begin{align}
\alpha \sim & \, Ga(\delta,\delta)
\label{eq:alpha}\\
v_i|\alpha \sim & \, Be(1,\alpha)\quad i\in\{1,...,T\}
\label{eq:v}\\
\lambda_i\sim & \, Ga(\delta,\delta)\quad i\in\{1,...,T\}\\
%\kappa_i|a,b\sim & \, Ga(\delta,\delta) \quad i\in\{1,...,\infty\}\\
\mathbf{z}_n|\mathbf{v}\sim & \, Mult(\pi(\mathbf{v})) \quad n\in\{1,...,N\} \\
\mathbf{x}_n|\mathbf{z}_n\sim & \, exp(\lambda_{z_n}) \quad n\in\{1,...,N\}
\label{eq:gen}
\end{align}
In this case we consider the truncated DP where the number of clusters is limited by $T$, which is a large number. This implies that $v_{T+1}=1$.

\textbf{For $\alpha$},
\begin{align}
\nonumber&\prod_{i=1}^{\infty}p(v_i|\alpha)p(\alpha)\\
\nonumber\log q(\alpha)\propto &  \sum_{i=1}^{\infty}\clrbracket{ \log\clrbracket{\frac{\Gamma(1+\alpha)}{\Gamma(1)\Gamma(\alpha)}}+\alpha\clrangle{\log (1-v_i)}}+(\delta-1)\log \alpha -(\delta)\alpha\\
\propto & (T+\delta-1)\log \alpha-\clrbracket{\delta-\sum_{i=1}^{T} \clrangle{\log (1-v_i)}} \alpha
\end{align}
Thus we have a gamma distribution on $\alpha$. The expected value $\clrangle{\alpha}=\frac{T+\delta}{\delta-\sum_{i=1}^{T} \clrangle{\log (1-v_i)}}$.

\textbf{For $v_i $}
\begin{align}
\nonumber& \prod_{n=1}^{N}p(z_n|\bigcup_{i=1}^{\infty}v_i)\prod_{i=1}^{\infty}p(v_i|\alpha)\\
\nonumber \log q(v_i)\propto & \csum \clrangle{\log p(z_n|\bigcup_{i=1}^{\infty}v_i)}+\clrangle{\log p(v_i|\alpha)}\\
\nonumber \propto&\sum_{n=1}^{N}1(z_n>i)\log(1-v_i)+1(z_n=i)\log(v_i)+(\clrangle{\alpha}-1)\log (1-v_i)\\
q(v_i) \propto & \,v_i^{\sum_{n=1}^{N} q(z_n=i)+1-1}(1-v_i)^{\sum_{n=1}^{N} q(z_n>i)+\clrangle{\alpha}-1}
\end{align}
Thus we have a beta distribution. The expectations $\clrangle{\log v_i}=\psi(\gamma_{1i})-\psi(\gamma_{1i}+\gamma_{2i})$ and $\clrangle{\log 1-v_i}=\psi(\gamma_{2i})-\psi(\gamma_{1i}+\gamma_{2i})$ are required.

\textbf{For $z_n$}
\begin{align}
\nonumber&\prod_{n=1}^{N} p(x_n|z_n)p(z_n|\cv)\\
\nonumber\log q(z_n)\propto &\csum 1(z_n=i)\clrangle{\log p(x_n|\lambda_t)}+\sum_{i=1}^{\infty} 1(z_n>i)\clrangle{\log(1-v_i)}+1(z_n=i)\clrangle{\log v_i}\\
\log q(z_n=t)\propto &\clrbracket{z_n=t}\clrbracket{\clrangle{\log \lambda_t}-\clrangle{\lambda_t}x_n+\clrangle{\log(v_t)}+\sum_{i=1}^{t-1}\clrangle{\log(1-v_i)}}
\end{align}
A multinomial is obtained for each observation $x_n$. Let $\pi_{n,t}\equiv q(z_n=t)$ and $\tilde{\pi_{n,t}}=\clrangle{\log \lambda_t}-\clrangle{\lambda_t}x_n+\clrangle{\log(v_t)}+\sum_{i=1}^{t-1}\clrangle{\log(1-v_i)}$. Thus,
\begin{align}
\pi_{n,t}=\frac{\tilde{\pi_{n,t}}}{\sum_{t=1}^{T}\tilde{\pi_{n,t}}}
\end{align}

\textbf{For $\lambda_t$}
\begin{align}
\nonumber & \prod_{n=1}^{N}p(x_n|z_n=t,\lambda_t) p(\lambda_t)\\
\nonumber & \log q(\lambda_t) \propto \sum_{n=1}^{N}q(z_n=t)\clrbracket{\log\lambda_t-\lambda_t x_n}+(\delta-1)\log\lambda_t-\delta\lambda_t\\
& \log q(\lambda_t) \propto \clrbracket{\csumn q(z_n=t) +\delta -1}\log\lambda_t-\clrbracket{\csumn q(z_n=t)x_n+\delta}\lambda_t
\end{align}
A gamma distribution is obtained where the expectations $\clrangle{\lambda_t}=\frac{\csumn q(z_n=t) +\delta}{\csumn q(z_n=t)x_n+\delta}$ and $\clrangle{\log\lambda_t}=\psi(\csumn q(z_n=t) +\delta)-\log(\csumn q(z_n=t)x_n+\delta)$.
\end{document}